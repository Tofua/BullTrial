<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Power BI Report Embed</title>
  <!-- Include the Power BI JavaScript client library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/powerbi-client/2.19.1/powerbi.min.js"></script>
  <style>
    #reportContainer {
      width: 100%;
      height: 600px;
    }
  </style>
</head>
<body>
  <div id="reportContainer"></div>
  <script>
    document.addEventListener("DOMContentLoaded", async function () {
      // Endpoint that returns an AAD token for the report.
      const tokenUrl = "https://powerbi-auth-api-a7d4aydgc2d4hrhu.uksouth-01.azurewebsites.net/get-token";
      
      try {
        const response = await fetch(tokenUrl);
        const data = await response.json();
        console.log("Token API response:", data);
        
        if (!data.accessToken) {
          console.error("No access token found in response.");
          return;
        }
        
        const accessToken = data.accessToken;
        
        // Get models from the Power BI client library.
        let models = window['powerbi-client'].models;
        if (!models) {
          console.error("Power BI models not found.");
          return;
        }
        
        // Configure the embed settings as per "Embed for your organization" guidelines.
        const embedConfiguration = {
          type: "report",
          id: "782913b3-f792-4f84-bc87-d46092f64932", // Replace with your report ID
          embedUrl: "https://app.powerbi.com/reportEmbed", // Base URL for AAD-based embedding
          tokenType: models.TokenType.Aad, // Use AAD token for embed-for-your-organization
          accessToken: accessToken,
          permissions: models.Permissions.All,
          settings: {
            panes: {
              filters: { visible: true },
              pageNavigation: { visible: true }
            },
            bars: {
              statusBar: { visible: true }
            }
          }
        };
        
        // Get the container element where the report will be embedded.
        const reportContainer = document.getElementById("reportContainer");
        if (!reportContainer) {
          console.error("Report container not found.");
          return;
        }
        
        // Embed the report using the global powerbi object.
        let report = powerbi.embed(reportContainer, embedConfiguration);
        
        // Optionally, add event listeners for debugging.
        report.on("loaded", function () {
          console.log("Report loaded.");
        });
        report.on("rendered", function () {
          console.log("Report rendered.");
        });
        report.on("error", function (event) {
          console.error("Report error:", event.detail);
        });
      } catch (error) {
        console.error("Error fetching token or embedding report:", error);
      }
    });
  </script>
</body>
</html>
