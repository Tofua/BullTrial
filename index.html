<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Power BI Report Embed</title>
  <!-- Include the Power BI client library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/powerbi-client/2.19.1/powerbi.min.js"></script>
  <style>
    #embedContainer {
      width: 100%;
      height: 600px;
    }
  </style>
</head>
<body>
  <div id="embedContainer"></div>

  <script>
    document.addEventListener('DOMContentLoaded', async function() {
      // Fetch the token from your API endpoint
      const tokenUrl = "https://powerbi-auth-api-a7d4aydgc2d4hrhu.uksouth-01.azurewebsites.net/get-token";

      try {
        const response = await fetch(tokenUrl);
        const data = await response.json();
        if (!data.token) {
          console.error("No token found in response.");
          return;
        }
        const accessToken = data.token;

        // Define embed configuration
        const config = {
          type: 'report',
          tokenType: window['powerbi-client'].models.TokenType.Embed,
          accessToken: accessToken,
          embedUrl: "https://app.powerbi.com/reportEmbed?reportId=782913b3-f792-4f84-bc87-d46092f64932&autoAuth=true&ctid=37732b96-4974-4df0-ae3d-3f5bab5f9564",
          id: "782913b3-f792-4f84-bc87-d46092f64932",
          permissions: window['powerbi-client'].models.Permissions.All,
          settings: {
            panes: {
              filters: { visible: true },
              pageNavigation: { visible: true }
            },
            bars: {
              statusBar: { visible: true }
            }
          }
        };

        // Get container element (using vanilla JS)
        const embedContainer = document.getElementById('embedContainer');
        if (!embedContainer) {
          console.error("Embed container not found.");
          return;
        }

        // Embed the report
        const report = window['powerbi-client'].embed(embedContainer, config);

        // Set up event listeners
        report.off("loaded");
        report.on("loaded", function() {
          console.log("Report loaded.");
        });

        report.off("error");
        report.on("error", function(event) {
          console.error("Error:", event.detail);
        });

        report.off("rendered");
        report.on("rendered", function() {
          console.log("Report rendered.");
        });
      } catch (error) {
        console.error("Error fetching token or embedding report:", error);
      }
    });
  </script>
</body>
</html>
