<!DOCTYPE html>
<html>
<head>
    <!-- Toastr CSS + JS -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <script type="text/javascript">window.$crisp=[];window.CRISP_WEBSITE_ID="fbcb448a-beca-4eb3-9ff0-aa11729254b2";(function(){d=document;s=d.createElement("script");s.src="https://client.crisp.chat/l.js";s.async=1;d.getElementsByTagName("head")[0].appendChild(s);})();</script>
  <meta charset="UTF-8">
  <title>BullWhip App</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/powerbi-client/2.19.1/powerbi.min.js"></script>
  <style>
    /* -----------------------------------------------------------
       1) Base Reset + Font
    ----------------------------------------------------------- */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      margin: 0;
      padding: 0;
      height: 100vh;
      overflow: hidden;
      position: relative;
      background-color: #f5f5f5;
    }

    /* -----------------------------------------------------------
       2) Canvas Background for Floating Circles
    ----------------------------------------------------------- */
    #canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 0; /* behind everything else */
    }

    /* -----------------------------------------------------------
       3) LOGIN SECTION
         - We wrap the login card in its own container (#loginSection).
    ----------------------------------------------------------- */
    #loginSection {
      width: 100%;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
      z-index: 1; /* in front of the canvas */
    }
    .login-card {
      width: 360px;
      background: white;
      padding: 40px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      position: relative;
    }
    /* Small brand accent bar at the top of the login card */
    .brand-accent {
      height: 4px;
      background: #F05123; /* from login.html brand color */
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      border-radius: 8px 8px 0 0;
    }
    .login-header {
      margin-bottom: 32px;
      text-align: center;
      margin-top: 8px; /* so we see the accent bar above it */
    }
    .login-header h2 {
      color: #333;
      font-weight: 500;
      font-size: 22px;
      margin-bottom: 6px;
    }
    .form-group {
      margin-bottom: 20px;
    }
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #555;
      font-size: 14px;
    }
    .form-group input {
      width: 100%;
      padding: 12px;
      background: #fff;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      font-size: 15px;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .form-group input:focus {
      outline: none;
      border-color: #F05123;
      box-shadow: 0 0 0 3px rgba(240, 81, 35, 0.1);
    }
    .login-button {
      width: 100%;
      padding: 12px;
      background: #F05123;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 15px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s, transform 0.2s;
      margin-top: 8px;
    }
    .login-button:hover {
      background: #d84418;
      transform: translateY(-1px);
    }
    .login-button:active {
      transform: translateY(1px);
    }
    .error-message {
      background-color: #fff8f8;
      color: #e55353;
      padding: 12px;
      border-radius: 6px;
      font-size: 14px;
      margin-top: 16px;
      display: none;
      text-align: center;
      border: 1px solid #fcd8d8;
    }

    /* -----------------------------------------------------------
       4) DASHBOARD SECTION (Initially Hidden)
    ----------------------------------------------------------- */
    #dashboardSection {
      display: none; /* hidden until user logs in */
      width: 100%;
      height: 100vh;
      position: relative;
      z-index: 1;
    }
    #reportContainer {
      width: 100%;
      height: 100vh;
      position: relative;
    }

    /* Floating controls container - from alittlebitofdislittlebitofdat19.html */
    #floatingControls {
      position: fixed;
      top: 15px;
      right: 120px;
      z-index: 2147483647;
      display: flex;
      gap: 10px;
      background-color: rgba(255, 255, 255, 0.95);
      padding: 10px;
      border-radius: 4px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      cursor: move; /* Draggable */
      user-select: none; 
    }
    .control-button {
      width: 36px;
      height: 36px;
      border-radius: 4px;
      border: 1px solid #ddd;
      background-color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .control-button:hover {
      background-color: #f0f0f0;
    }
    .control-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* The small "Loading..." indicator in the corner */
    #loadingIndicator {
      position: fixed;
      top: 15px;
      left: 15px;
      padding: 8px 12px;
      background-color: rgba(255, 243, 205, 0.9);
      color: #856404;
      border-radius: 4px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      z-index: 2147483647; 
      display: none;
      max-width: 250px;
    }
    /* Big overlay for normal loading events */
    #loadingOverlay {
  position: fixed; 
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: transparent; /* remove the frosted effect */
  pointer-events: none;          /* allow interaction with elements behind */
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  z-index: 2147483647; 
  display: none;
}
    /* Non-blocking spinner for refresh */
    #refreshSpinner {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 2147483648; 
      pointer-events: none; 
      display: none;
    }
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3; 
      border-top: 4px solid #0078d4; 
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0%   { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .loading-text {
      margin-top: 10px;
      font-size: 14px;
      color: #333;
      background-color: rgba(255, 255, 255, 0.8);
      padding: 5px 10px;
      border-radius: 4px;
    }

    /* Error message style reused from snippet */
    .error {
      position: fixed;
      top: 15px;
      left: 15px;
      color: #721c24;
      background-color: rgba(248, 215, 218, 0.9);
      border: 1px solid rgba(245, 198, 203, 0.9);
      padding: 10px;
      border-radius: 4px;
      z-index: 2147483647;
      max-width: 80%;
      display: none;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }

    /* Fullscreen message prompt */
    #fullscreenPrompt {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      padding: 60px 30px 30px 30px;
      background-color: rgba(255, 255, 255, 0.95);
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      text-align: center;
      z-index: 2147483647;
      width: 300px;
      display: none; /* hidden by default */
      flex-direction: column;
      align-items: center;
      gap: 15px;
    }
    #fullscreenPrompt p {
      margin: 0;
      font-size: 16px;
    }
    #fullscreenPrompt button {
      padding: 10px 20px;
      background-color: #0078d4;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
    }
    #fullscreenPrompt button:hover {
      background-color: #0069b9;
    }
    #closeFullscreenPrompt {
      position: absolute;
      top: 15px;
      right: 15px;
      width: 24px;
      height: 24px;
      background-color: transparent;
      border: none;
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #666;
    }
    #closeFullscreenPrompt:hover {
      color: #333;
    }
    .fullscreen-icon {
      transition: all 0.3s ease;
    }
  </style>
</head>

<body>
  <!-- The floating circles canvas -->
  <canvas id="canvas"></canvas>

<!-- LOGIN SECTION -->
<div id="loginSection">
  <div class="login-card">
    <div class="brand-accent"></div>
    <div class="login-header">
      <!-- Replace this src with the correct logo path or URL -->
      <img src="images/Bull_Run_Logo_Png.png" alt="Company Logo" style="height: 80px; margin-bottom: 16px;">
      <h2>BullWhip Login</h2>
    </div>
    
    <div class="form-group">
      <label for="username">Username</label>
      <input type="text" id="username" placeholder="Enter username">
    </div>
    
    <div class="form-group">
      <label for="password">Password</label>
      <input type="password" id="password" placeholder="Enter password">
    </div>
    
    <button type="button" class="login-button" id="loginBtn">Login</button>

    <div class="error-message" id="loginErrorMsg">
      Invalid username or password. Please try again.
    </div>
  </div>
</div>


  <!-- DASHBOARD SECTION (hidden until login) -->
  <div id="dashboardSection">
    <div id="errorMessage" class="error"></div>
    <div id="loadingIndicator">Loading...</div>
    <div id="loadingOverlay">
      <div class="spinner"></div>
      <div class="loading-text">Loading...</div>
    </div>
    <div id="refreshSpinner">
      <div class="spinner"></div>
    </div>
      <!-- Add the logout button here -->
  <button id="logoutBtn" style="position: fixed; top: 15px; right: 15px; z-index: 2147483647; padding: 8px 15px; background-color: #F05123; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">Logout</button>
  
  <div id="reportContainer"></div>
  <div id="fullscreenPrompt">
    <button id="closeFullscreenPrompt" title="Close">✕</button>
    <p>Click the button below to enter fullscreen mode</p>
    <button id="promptFullscreenBtn">Enter Fullscreen</button>
  </div>
</div>
    <div id="reportContainer"></div>
    <div id="fullscreenPrompt">
      <button id="closeFullscreenPrompt" title="Close">✕</button>
      <p>Click the button below to enter fullscreen mode</p>
      <button id="promptFullscreenBtn">Enter Fullscreen</button>
    </div>
  </div>
  <script>
    // Get references to your logout button and relevant sections
    const logoutBtn = document.getElementById('logoutBtn');
  
    logoutBtn.addEventListener('click', () => {
      // 1) Clear any saved filter values or user info
      filterValues = {
        orgIN: "",
        userIN: ""
      };
  
      // 2) Hide the dashboard
      dashboardSection.style.display = 'none';
  
      // 3) Show the login section again
      loginSection.style.display = 'flex';
  
      // 4) Reset or remove the embedded Power BI report
      //    so the next login uses a fresh embed.
      const reportContainer = document.getElementById('reportContainer');
      powerbi.reset(reportContainer);
  
      // 5) (Optional) remove or hide any floating controls so
      //    they don’t stay on screen.
      const floatingControls = document.getElementById('floatingControls');
      if (floatingControls) {
        floatingControls.remove();
      }
  
      // 6) (Optional) clear username / password fields
      usernameInput.value = '';
      passwordInput.value = '';
    });
  </script>
  

  <script>
    /* ===========================================================
       PART A: CANVAS BACKGROUND & FLOATING CIRCLES (from login.html)
    =========================================================== */
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    function setCanvasSize() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', setCanvasSize);
    setCanvasSize();

    let mouse = {
      x: undefined,
      y: undefined,
      radius: 120
    };
    window.addEventListener('mousemove', function(event) {
      mouse.x = event.x;
      mouse.y = event.y;
    });

    class Circle {
      constructor(x, y, radius, color) {
        this.x = x;
        this.y = y;
        this.radius = radius;
        this.color = color;
        this.baseRadius = radius;

        this.speedX = (Math.random() - 0.5) * 0.3;
        this.speedY = (Math.random() - 0.5) * 0.3;

        this.speedVariation = Math.random() * 0.05;
        this.speedAngle = Math.random() * Math.PI * 2;

        this.density = (Math.random() * 15) + 5;
        this.opacity = 0.5 + Math.random() * 0.3;
      }

      draw() {
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2, false);
        ctx.fillStyle = this.color;
        ctx.globalAlpha = this.opacity;
        ctx.fill();
        ctx.globalAlpha = 1;
      }

      update() {
        // Slight wave movement
        this.speedX += Math.sin(this.speedAngle) * this.speedVariation;
        this.speedY += Math.cos(this.speedAngle) * this.speedVariation;
        this.speedAngle += 0.005;

        // Limit speed
        if (this.speedX > 0.4) this.speedX = 0.4;
        if (this.speedX < -0.4) this.speedX = -0.4;
        if (this.speedY > 0.4) this.speedY = 0.4;
        if (this.speedY < -0.4) this.speedY = -0.4;

        this.x += this.speedX;
        this.y += this.speedY;

        // Boundary bounce
        if (this.x < this.radius) {
          this.x = this.radius;
          this.speedX = -this.speedX;
        }
        if (this.x > canvas.width - this.radius) {
          this.x = canvas.width - this.radius;
          this.speedX = -this.speedX;
        }
        if (this.y < this.radius) {
          this.y = this.radius;
          this.speedY = -this.speedY;
        }
        if (this.y > canvas.height - this.radius) {
          this.y = canvas.height - this.radius;
          this.speedY = -this.speedY;
        }

        // Mouse interaction
        if (mouse.x !== undefined && mouse.y !== undefined) {
          const dx = mouse.x - this.x;
          const dy = mouse.y - this.y;
          const distance = Math.sqrt(dx * dx + dy * dy);

          if (distance < mouse.radius + this.radius) {
            const angle = Math.atan2(dy, dx);
            const force = (mouse.radius - distance) / mouse.radius;
            const moveX = Math.cos(angle) * force * this.density;
            const moveY = Math.sin(angle) * force * this.density;

            this.x -= moveX * 0.7;
            this.y -= moveY * 0.7;
          }
        }
        this.draw();
      }
    }

    let circles = [];
    function initCircles() {
      circles = [];
      const screenArea = canvas.width * canvas.height;
      const circleCount = Math.max(20, Math.min(80, Math.floor(screenArea / 15000)));

      const colors = [
        'rgba(240, 81, 35, 0.07)',   // Very subtle brand color
        'rgba(240, 81, 35, 0.05)',   // Even more subtle brand color
        'rgba(245, 245, 245, 0.5)',  // Light gray
        'rgba(250, 250, 250, 0.5)',  // Off-white
        'rgba(240, 240, 240, 0.5)'   // Another light gray
      ];

      for (let i = 0; i < circleCount; i++) {
        const radius = Math.random() * 20 + 5;
        const x = Math.random() * (canvas.width - radius * 2) + radius;
        const y = Math.random() * (canvas.height - radius * 2) + radius;
        const color = colors[Math.floor(Math.random() * colors.length)];
        circles.push(new Circle(x, y, radius, color));
      }
    }
    function animate() {
      requestAnimationFrame(animate);
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      circles.forEach(circle => {
        circle.update();
      });
    }
    initCircles();
    animate();

    window.addEventListener('resize', function() {
      setCanvasSize();
      initCircles();
    });
    window.addEventListener('mouseout', function() {
      mouse.x = undefined;
      mouse.y = undefined;
    });

/* ===========================================================
   PART B: LOGIN & DASHBOARD LOGIC (from alittlebitofdislittlebitofdat19.html)
=========================================================== */
const loginSection = document.getElementById('loginSection');
const dashboardSection = document.getElementById('dashboardSection');
const loginBtn = document.getElementById('loginBtn');
const loginErrorMsg = document.getElementById('loginErrorMsg');
const usernameInput = document.getElementById('username');
const passwordInput = document.getElementById('password');

// Updated user credentials with usrID only
const userCredentials = [
  { username: "Admin", password: "Adminisbullwhip1000", usrID: 1 },
  { username: "MikeP", password: "BullMike", usrID: 2 },
  { username: "NeilG", password: "BullNeil", usrID: 3 }
];

// Default to empty filter value (will be set after login)
let filterValues = {
  usrID: ""
};

function attemptLogin() {
  const username = usernameInput.value.trim();
  const password = passwordInput.value;

  // Find matching credentials
  const user = userCredentials.find(
    u => u.username.toLowerCase() === username.toLowerCase() && u.password === password
  );

  if (user) {
    // Set filter value based on user credentials
    filterValues.usrID = user.usrID;
    
    // Hide login, show dashboard
    loginSection.style.display = 'none';
    dashboardSection.style.display = 'block';
    loginErrorMsg.style.display = 'none';
    
    // Now initialize the Power BI embed
    initializeDashboard();
  } else {
    // Show error
    loginErrorMsg.style.display = 'block';
    passwordInput.value = '';
    setTimeout(() => {
      loginErrorMsg.style.display = 'none';
    }, 3000);
  }
}

loginBtn.addEventListener('click', attemptLogin);
passwordInput.addEventListener('keypress', (e) => {
  if (e.key === 'Enter') {
    attemptLogin();
  }
});

/* -----------------------------------------------------------
   Initialize the actual Power BI dashboard after login
----------------------------------------------------------- */
function initializeDashboard() {
  // Global variables for report tracking
  let currentAccessToken = "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6IkNOdjBPSTNSd3FsSEZFVm5hb01Bc2hDSDJYRSIsImtpZCI6IkNOdjBPSTNSd3FsSEZFVm5hb01Bc2hDSDJYRSJ9.eyJhdWQiOiJodHRwczovL2FuYWx5c2lzLndpbmRvd3MubmV0L3Bvd2VyYmkvYXBpIiwiaXNzIjoiaHR0cHM6Ly9zdHMud2luZG93cy5uZXQvMzc3MzJiOTYtNDk3NC00ZGYwLWFlM2QtM2Y1YmFiNWY5NTY0LyIsImlhdCI6MTc0Mzc2MDU2MCwibmJmIjoxNzQzNzYwNTYwLCJleHAiOjE3NDM3NjQ1NzAsImFjY3QiOjAsImFjciI6IjEiLCJhaW8iOiJBWFFBaS84WkFBQUFuZy94WEs1Q1psRmxzTEVDL2k2SXZMai9RRXhwVlhtdUxyTlg1WC9YbzFjNDFHTXRkdVdsMkZOWlJIYlZHOE8xQjIxdUJlTzJFR3g4dmNhdjlwcDhQTWlIWmRVbE1IbnpPV1dYTWl1Vllxc2xqbllyYXVFR29tbG50aWl2bmxmZHpIL0ErUTJkbUpiNTZKNU5jckFyTmc9PSIsImFtciI6WyJwd2QiLCJtZmEiXSwiYXBwaWQiOiI4NzFjMDEwZi01ZTYxLTRmYjEtODNhYy05ODYxMGE3ZTkxMTAiLCJhcHBpZGFjciI6IjAiLCJmYW1pbHlfbmFtZSI6InRyaWFsIiwiZ2l2ZW5fbmFtZSI6InRyaWFsIiwiaWR0eXAiOiJ1c2VyIiwiaXBhZGRyIjoiODQuNzEuNDMuOCIsIm5hbWUiOiJ0cmlhbDEiLCJvaWQiOiI3OTllMTc1OC0yY2VkLTQzNjAtYmE2Zi00NWIxY2Q2NzRkODciLCJwdWlkIjoiMTAwMzIwMDQyRjBGM0VDOCIsInJoIjoiMS5BUk1CbGl0ek4zUko4RTJ1UFQ5YnExLVZaQWtBQUFBQUFBQUF3QUFBQUFBQUFBQVRBZnNUQVEuIiwic2NwIjoidXNlcl9pbXBlcnNvbmF0aW9uIiwic2lkIjoiMDAxNDA1MTktZDk3Yy1iMWY0LWU2Y2UtNmNkMzdmMTVjNzgyIiwic2lnbmluX3N0YXRlIjpbImttc2kiXSwic3ViIjoieGdsWDluR2Y2cjFRS0ZLcVI5NUY1VFlqSElxdEs2QmFHVm1hcEZmY00tMCIsInRpZCI6IjM3NzMyYjk2LTQ5NzQtNGRmMC1hZTNkLTNmNWJhYjVmOTU2NCIsInVuaXF1ZV9uYW1lIjoidHJpYWxASG9zdERhdGEub25taWNyb3NvZnQuY29tIiwidXBuIjoidHJpYWxASG9zdERhdGEub25taWNyb3NvZnQuY29tIiwidXRpIjoiRGxBcGtROVp0a0NpN3ZHcEdKNWpBQSIsInZlciI6IjEuMCIsIndpZHMiOlsiYjc5ZmJmNGQtM2VmOS00Njg5LTgxNDMtNzZiMTk0ZTg1NTA5Il0sInhtc19pZHJlbCI6IjEgMTAifQ.JRzKYNQCn8kgF3Et67GHLLWNKgr3MM5DjuS4ww4amQKJ1-Bq61YfTYmoZJBKm9GtgkM3c-Sca-Ppwar55YOj4n3-rAsiNaaCdDLMQ41O_PLAEsf-kdM2tyWHbbT6lBz39Ea_pkkwfpkSYpXn_lY7X9DZmFoK5N3eCfmsvQiJXG7mInh93ICPYE2GH_Zo1mddax3JtFiC_4xejH0kMpTG95v2vaWrkMdm-O8Bt3B7apeQyD5CJMyJHVS-1kTN0PUxpAaBJPwOKZXmZ5Uf0-dJTYIwVO6X2Td5mAXxfBHHxlwH3MF1I-aycSkhwaez9Xi3iQT7LQFmqk-4tF5ss0ltWw";
  let report;
  let currentPage;
  let pages = [];

  // ***** Removed token refresh and expiration overlay functions *****
  // Since we're using a permanent hardcoded token, no token refresh logic is needed.

  // Create floating controls
  const floatingControls = document.createElement('div');
  floatingControls.id = 'floatingControls';
  floatingControls.innerHTML = `
    <button id="fullscreenBtn" class="control-button" title="Enter Fullscreen">
      <span class="button-label fullscreen-icon">
        <svg width="16" height="16" viewBox="0 0 24 24"
          fill="none" stroke="currentColor" stroke-width="2"
          stroke-linecap="round" stroke-linejoin="round">
          <polyline points="15 3 21 3 21 9"></polyline>
          <polyline points="9 21 3 21 3 15"></polyline>
          <line x1="21" y1="3" x2="14" y2="10"></line>
          <line x1="3" y1="21" x2="10" y2="14"></line>
        </svg>
      </span>
    </button>
    <button id="pageIconBtn" class="control-button" title="Change Page">
      <span class="button-label page-icon">
        <svg width="16" height="16" viewBox="0 0 24 24"
          fill="none" stroke="currentColor" stroke-width="2"
          stroke-linecap="round" stroke-linejoin="round">
          <circle cx="11" cy="11" r="8"></circle>
          <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
      </span>
    </button>
    <button id="refreshVisualsBtn" class="control-button" title="Refresh Visuals">
      <span class="button-label">↻</span>
    </button>
  `;
  document.body.appendChild(floatingControls);
  makeDraggable(floatingControls);

  function makeDraggable(element) {
    let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
    element.onmousedown = dragMouseDown;
    function dragMouseDown(e) {
      e.preventDefault();
      pos3 = e.clientX;
      pos4 = e.clientY;
      document.onmouseup = closeDragElement;
      document.onmousemove = elementDrag;
    }
    function elementDrag(e) {
      e.preventDefault();
      pos1 = pos3 - e.clientX;
      pos2 = pos4 - e.clientY;
      pos3 = e.clientX;
      pos4 = e.clientY;
      const newTop = element.offsetTop - pos2;
      const newLeft = element.offsetLeft - pos1;
      element.style.top = newTop + "px";
      element.style.left = newLeft + "px";
      element.style.right = "auto";
    }
    function closeDragElement() {
      document.onmouseup = null;
      document.onmousemove = null;
    }
  }

  function showLoading(message, mode = "normal") {
    const loadingIndicator = document.getElementById('loadingIndicator');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const refreshSpinner = document.getElementById('refreshSpinner');
    const overlayText = loadingOverlay.querySelector('.loading-text');

    const finalMessage = message || "Loading...";
    loadingIndicator.textContent = finalMessage;
    loadingIndicator.style.display = 'block';

    if (mode === "refresh") {
      refreshSpinner.style.display = 'block';
      loadingOverlay.style.display = 'none';
    } else {
      overlayText.textContent = finalMessage;
      loadingOverlay.style.display = 'flex';
      refreshSpinner.style.display = 'none';
    }
  }

  function hideLoading() {
    document.getElementById('loadingIndicator').style.display = 'none';
    document.getElementById('loadingOverlay').style.display = 'none';
    document.getElementById('refreshSpinner').style.display = 'none';
  }

  function showError(message) {
    const errorElement = document.getElementById('errorMessage');
    errorElement.style.display = 'block';
    errorElement.textContent = message;
    console.error(message);
    setTimeout(() => {
      errorElement.style.display = 'none';
    }, 7000);
  }

  function showFullscreenPrompt() {
    document.getElementById('fullscreenPrompt').style.display = 'flex';
  }

  function hideFullscreenPrompt() {
    document.getElementById('fullscreenPrompt').style.display = 'none';
  }

  document.getElementById('closeFullscreenPrompt').addEventListener('click', hideFullscreenPrompt);

  async function enterFullscreen() {
    if (!document.fullscreenElement) {
      if (document.documentElement.requestFullscreen) {
        await document.documentElement.requestFullscreen();
        const fullscreenIcon = document.querySelector('.fullscreen-icon');
        const fullscreenBtn = document.getElementById('fullscreenBtn');
        if (fullscreenIcon) {
          fullscreenIcon.textContent = '⤓';
          fullscreenBtn.title = "Exit Fullscreen";
        }
      }
    }
  }

  async function exitFullscreen() {
    if (document.exitFullscreen) {
      await document.exitFullscreen();
      const fullscreenIcon = document.querySelector('.fullscreen-icon');
      const fullscreenBtn = document.getElementById('fullscreenBtn');
      if (fullscreenIcon) {
        // Restore the original SVG
        fullscreenIcon.innerHTML = `
          <svg width="16" height="16" viewBox="0 0 24 24"
            fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <polyline points="15 3 21 3 21 9"></polyline>
            <polyline points="9 21 3 21 3 15"></polyline>
            <line x1="21" y1="3" x2="14" y2="10"></line>
            <line x1="3" y1="21" x2="10" y2="14"></line>
          </svg>`;
        fullscreenBtn.title = "Enter Fullscreen";
      }
    }
  }

  document.getElementById('promptFullscreenBtn').addEventListener('click', async () => {
    hideFullscreenPrompt();
    await enterFullscreen();
  });

  document.addEventListener('keydown', function (event) {
    if (event.key === 'F11') {
      event.preventDefault();
      const fullscreenBtn = document.getElementById('fullscreenBtn');
      if (fullscreenBtn) fullscreenBtn.click();
    }
  });

  document.addEventListener('fullscreenchange', function () {
    if (!document.fullscreenElement) {
      const fullscreenIcon = document.querySelector('.fullscreen-icon');
      const fullscreenBtn = document.getElementById('fullscreenBtn');
      if (fullscreenIcon) {
        fullscreenIcon.innerHTML = `
          <svg width="16" height="16" viewBox="0 0 24 24"
            fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <polyline points="15 3 21 3 21 9"></polyline>
            <polyline points="9 21 3 21 3 15"></polyline>
            <line x1="21" y1="3" x2="14" y2="10"></line>
            <line x1="3" y1="21" x2="10" y2="14"></line>
          </svg>`;
        fullscreenBtn.title = "Enter Fullscreen";
      }
    }
  });

  const pageIconBtn = document.getElementById('pageIconBtn');
  const fullscreenBtn = document.getElementById('fullscreenBtn');
  if (fullscreenBtn) {
    fullscreenBtn.addEventListener('click', async () => {
      if (document.fullscreenElement) {
        await exitFullscreen();
      } else {
        await enterFullscreen();
      }
    });
  }

  // ===== Using a permanently hardcoded embed token =====
  const reportId = "aadaa979-0c03-40fa-bc94-71017350542f";
  const models = window['powerbi-client'].models;

  // Log the filter value for debugging
  console.log(`Using filter for usrID=${filterValues.usrID}`);
  
  // Report-level filters: none (full page – no filters)
  const reportFilters = [];
  
  // Define filters for page 1 (Users table)
  const page1Filters = [
    {
      $schema: "http://powerbi.com/product/schema#basic",
      target: { table: "Users", column: "UserID" },
      operator: "In",
      values: [filterValues.usrID]
    }
  ];
  
  // Define filters for page 2 (UsersClone table)
  const page2Filters = [
    {
      $schema: "http://powerbi.com/product/schema#basic",
      target: { table: "UsersClone", column: "UserID" },
      operator: "In",
      values: [filterValues.usrID]
    }
  ];

  const embedConfiguration = {
    type: "report",
    id: reportId,
    embedUrl: `https://app.powerbi.com/reportEmbed?reportId=${reportId}`,
    tokenType: models.TokenType.Aad,
    accessToken: currentAccessToken,
    permissions: models.Permissions.Read,
    settings: {
      panes: {
        filters: { visible: false },
        pageNavigation: { visible: false }
      },
      bars: {
        statusBar: { visible: true }
      }
    }
  };

  // Apply specific filters to a specific page by name
  async function applyFiltersToPage(pageName, pageFilters) {
    try {
      // Get all pages
      const allPages = await report.getPages();
      console.log("Available pages:", allPages.map(p => ({name: p.name, displayName: p.displayName})));
      
      // Find the target page by name or display name
      const targetPage = allPages.find(p => 
        p.name === pageName || 
        p.displayName === pageName ||
        p.name.includes(pageName) || 
        p.displayName.includes(pageName)
      );
      
      if (!targetPage) {
        console.error(`Page "${pageName}" not found. Available pages: ${allPages.map(p => p.name).join(", ")}`);
        return false;
      }
      
      console.log(`Applying filters to page: ${targetPage.displayName} (${targetPage.name})...`);
      await targetPage.setFilters(pageFilters);
      console.log(`Filters applied successfully to page: ${targetPage.displayName}`);
      
      return true;
    } catch (error) {
      console.error("Error applying filters:", error);
      return false;
    }
  }

  function setupLoadingTracking(report) {
    showLoading("Loading report...", "normal");
    
    report.on("loaded", async function() {
      const loadingText = document.querySelector('#loadingOverlay .loading-text');
      loadingText.textContent = 'Applying filters and rendering visuals...';
      
      try {
        // Apply report-level filters (none in this case)
        console.log("Applying report-level filters...");
        await report.setFilters(reportFilters);
        console.log("Report-level filters applied successfully");
        
        // Get and set up pages
        await getReportPages();
        
        // Apply page-specific filters
        await applyFiltersToPage("Prospect", page1Filters);
        await applyFiltersToPage("Pinpoint", page2Filters);
        
      } catch (error) {
        console.error("Error during filter application:", error);
      }
      
      setTimeout(function() {
        showFullscreenPrompt();
      }, 1000);
    });
    
    report.on("rendered", function() {
      hideLoading();
    });
    
    report.on("pageChanged", (event) => {
      const newPage = event.detail.newPage;
      showLoading(`Loading page: ${newPage.displayName}...`, "normal");
      currentPage = pages.find(p => p.name === newPage.name) || newPage;
    });
    
    report.on("renderingStarted", function() {
      showLoading("Processing...", "normal");
    });
    
    report.on("visualRendered", function(event) {
      document.getElementById('loadingIndicator').textContent =
        `Rendered visual: ${event.detail.name}`;
    });
    
    // Modified error handler to show any errors
    report.on("error", function(event) {
      showError(`Error: ${event.detail.message}`);
      hideLoading();
    });
  }

  async function getReportPages() {
    try {
      pages = await report.getPages();
      currentPage = await report.getActivePage();
      const currentIndex = pages.findIndex(p => p.name === currentPage.name);
      updatePageIcon(currentIndex);
    } catch (error) {
      showError(`Error loading pages: ${error.message}`);
    }
  }
  
  function updatePageIcon(pageIndex) {
    const pageIcon = document.querySelector('.page-icon');
    const pageIconBtn = document.getElementById('pageIconBtn');
    if (!pageIcon) return;
    switch (pageIndex) {
      case 0:
        pageIcon.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24"
          fill="none" stroke="currentColor" stroke-width="2"
          stroke-linecap="round" stroke-linejoin="round">
          <circle cx="11" cy="11" r="8"></circle>
          <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>`;
        pageIconBtn.title = "Search Page";
        break;
      case 1:
        pageIcon.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24"
          fill="none" stroke="currentColor" stroke-width="2"
          stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
          <circle cx="12" cy="10" r="3"></circle>
        </svg>`;
        pageIconBtn.title = "Pin Page";
        break;
      default:
        pageIcon.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24"
          fill="none" stroke="currentColor" stroke-width="2"
          stroke-linecap="round" stroke-linejoin="round">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
          <polyline points="14 2 14 8 20 8"></polyline>
          <line x1="16" y1="13" x2="8" y2="13"></line>
          <line x1="16" y1="17" x2="8" y2="17"></line>
          <polyline points="10 9 9 9 8 9"></polyline>
        </svg>`;
        pageIconBtn.title = "Page " + (pageIndex + 1);
    }
  }
  
  async function navigateToNextPage() {
    try {
      if (!pages.length || !currentPage) {
        await getReportPages();
        if (!pages.length || !currentPage) {
          throw new Error("Pages not available");
        }
      }
      const currentIndex = pages.findIndex(p => p.name === currentPage.name);
      const nextIndex = (currentIndex + 1) % pages.length;
      const nextPage = pages[nextIndex];
      showLoading(`Loading page: ${nextPage.displayName}...`, "normal");
      await nextPage.setActive();
      currentPage = nextPage;
      updatePageIcon(nextIndex);
    } catch (error) {
      showError(`Navigation error: ${error.message}`);
      hideLoading();
    }
  }
  
  if (pageIconBtn) {
    pageIconBtn.addEventListener('click', async () => {
      await navigateToNextPage();
    });
  }

  // Refresh Visuals
  const refreshBtn = document.getElementById('refreshVisualsBtn');
  if (refreshBtn) {
    refreshBtn.addEventListener('click', async () => {
      try {
        showLoading("Refreshing visuals...", "refresh");
        await report.refresh({ type: "visual" });
      } catch (error) {
        showError(`Visual refresh error: ${error.message}`);
        hideLoading();
      }
    });
  }

  // Finally embed the report
  try {
    showLoading("Loading report...", "normal");
    const reportContainer = document.getElementById('reportContainer');
    report = powerbi.embed(reportContainer, embedConfiguration);
    setupLoadingTracking(report);
  } catch (error) {
    showError(`Initialization error: ${error.message}`);
    hideLoading();
  }
}
</script>
<script>
  // --- Polling settings ---
  const pollingInterval = 10000; // Check every 10 seconds
  const storageContainerUrl = "https://tofsbigdataa77f.blob.core.windows.net/webhookstore"; // Public read access must be enabled
  
  // Track already seen files to avoid duplicate notifications
  const seenFiles = new Set();
  
  // Notification system
  class NotificationSystem {
    constructor() {
      this.notifications = [];
      this.historyData = [];
      this.container = null;
      this.historyTab = null;
      this.historyPanel = null;
      this.isHistoryOpen = false;
      
      // Define SVG icons
      this.icons = {
        phone: `<svg class="icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.127.96.361 1.903.7 2.81a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0 1 22 16.92z"></path>
        </svg>`,
        x: `<svg class="icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>`,
        close: `<svg class="icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>`,
        chevronDown: `<svg class="icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <polyline points="6 9 12 15 18 9"></polyline>
        </svg>`,
        history: `<svg class="icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <polyline points="12 8 12 12 14 14"></polyline>
          <path d="M3.05 11a9 9 0 1 1 .5 4m-.5 5v-5h5"></path>
        </svg>`
      };
      
      this.initStyles();
      this.initContainer();
      this.initHistoryTab();
    }
  
    initStyles() {
      // Add styles to document
      const style = document.createElement('style');
      style.textContent = `
        /* SVG Icon styles */
        .icon {
          display: inline-flex;
          align-items: center;
          justify-content: center;
          height: 20px;
          width: 20px;
          stroke-width: 2;
          stroke: currentColor;
          fill: none;
        }
        
        .notification-container {
          position: fixed;
          bottom: 100px;
          right: 30px;
          z-index: 9998;
          display: flex;
          flex-direction: column;
          gap: 10px;
          font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        
        .notification {
          background: linear-gradient(135deg, #F05123, #F07123);
          color: white;
          border-radius: 12px;
          box-shadow: 0 4px 15px rgba(240, 81, 35, 0.25);
          overflow: hidden;
          width: 300px;
          transition: all 0.3s ease;
          opacity: 0;
          transform: translateX(50px);
        }
        
        .notification.failure {
          background: linear-gradient(135deg, #6c757d, #495057);
          box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
          width: 280px;
        }
        
        .notification.show {
          opacity: 1;
          transform: translateX(0);
        }
        
        .notification-header {
          padding: 12px 16px;
          display: flex;
          align-items: center;
          justify-content: space-between;
          cursor: pointer;
        }
        
        .notification-title {
          display: flex;
          align-items: center;
          gap: 8px;
          font-weight: 600;
        }
        
        .notification-icon {
          font-size: 18px;
          display: flex;
          align-items: center;
          justify-content: center;
        }
        
        .notification-icon .icon {
          stroke-width: 2.5;
        }
        
        .notification-content {
          max-height: 0;
          overflow: hidden;
          transition: max-height 0.3s ease;
          padding: 0 16px;
        }
        
        .notification-content.expanded {
          max-height: 200px;
          padding-bottom: 12px;
        }
        
        .close-btn {
          background: none;
          border: none;
          color: white;
          cursor: pointer;
          opacity: 0.7;
          transition: opacity 0.2s;
          padding: 0;
          font-size: 16px;
          display: flex;
          align-items: center;
          justify-content: center;
        }
        
        .close-btn:hover {
          opacity: 1;
        }
        
        .notification-phone {
          margin: 4px 0;
          font-size: 14px;
          opacity: 0.9;
        }
        
        .notification-name {
          font-size: 16px;
          margin-top: 6px;
        }
        
        .notification-company {
          font-size: 14px;
          opacity: 0.9;
          margin-top: 2px;
          font-style: italic;
        }
        
        .expand-icon {
          transition: transform 0.3s ease;
          margin-left: 8px;
          font-size: 12px;
          display: flex;
          align-items: center;
        }
        
        .expanded .expand-icon {
          transform: rotate(180deg);
        }
        
        /* History Tab Styles */
        .history-tab {
          position: fixed;
          bottom: 100px;
          right: 30px;
          background: linear-gradient(135deg, #F05123, #F07123);
          color: white;
          width: 50px;
          height: 50px;
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          cursor: pointer;
          box-shadow: 0 4px 15px rgba(240, 81, 35, 0.25);
          z-index: 9999;
          transition: all 0.3s ease;
        }
        
        .history-tab .icon {
          width: 22px;
          height: 22px;
        }
        
        .history-tab:hover {
          transform: scale(1.05);
        }
        
        .history-tab-icon {
          font-size: 22px;
        }
        
        .history-panel {
          position: fixed;
          bottom: 160px;
          right: 30px;
          background: white;
          border-radius: 12px;
          box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
          width: 320px;
          max-height: 400px;
          z-index: 9997;
          overflow: hidden;
          transition: all 0.3s ease;
          opacity: 0;
          transform: translateY(20px);
          pointer-events: none;
        }
        
        .history-panel.open {
          opacity: 1;
          transform: translateY(0);
          pointer-events: all;
        }
        
        .history-header {
          padding: 15px;
          background: linear-gradient(135deg, #F05123, #F07123);
          color: white;
          font-weight: 600;
          display: flex;
          justify-content: space-between;
          align-items: center;
        }
        
        .history-content {
          overflow-y: auto;
          max-height: 340px;
          padding: 10px 0;
        }
        
        .history-item {
          padding: 10px 15px;
          border-bottom: 1px solid #f0f0f0;
          cursor: pointer;
          transition: background 0.2s;
        }
        
        .history-item:hover {
          background: #f8f9fa;
        }
        
        .history-item.history-item-failure {
          background-color: #f8f9fa;
          border-left: 3px solid #6c757d;
        }
        
        .history-item.history-item-failure:hover {
          background: #f0f0f0;
        }
        
        .history-item-header {
          display: flex;
          justify-content: space-between;
          font-weight: 500;
          margin-bottom: 5px;
        }
        
        .history-timestamp {
          font-size: 12px;
          color: #6c757d;
        }
        
        .history-phones {
          font-size: 14px;
          color: #495057;
        }
        
        .empty-history {
          padding: 30px 15px;
          text-align: center;
          color: #6c757d;
          font-style: italic;
        }
        
        .notification-badge {
          position: absolute;
          top: 0;
          right: 0;
          background: #dc3545;
          color: white;
          border-radius: 50%;
          width: 20px;
          height: 20px;
          font-size: 12px;
          display: flex;
          align-items: center;
          justify-content: center;
          transform: translate(30%, -30%);
          opacity: 0;
          transition: opacity 0.3s;
        }
        
        .notification-badge.show {
          opacity: 1;
        }
        
        /* When history panel is open, adjust notifications container */
        .notification-container.history-open {
          bottom: 170px;
        }
      `;
      document.head.appendChild(style);
    }
  
    initContainer() {
      this.container = document.createElement('div');
      this.container.className = 'notification-container';
      document.body.appendChild(this.container);
    }
    
    initHistoryTab() {
      // Create history tab
      this.historyTab = document.createElement('div');
      this.historyTab.className = 'history-tab';
      this.historyTab.innerHTML = `
        ${this.icons.history}
        <span class="notification-badge">0</span>
      `;
      document.body.appendChild(this.historyTab);
      
      // Create history panel
      this.historyPanel = document.createElement('div');
      this.historyPanel.className = 'history-panel';
      this.historyPanel.innerHTML = `
        <div class="history-header">
          <span>Notification History</span>
          <button class="close-btn">${this.icons.close}</button>
        </div>
        <div class="history-content">
          <div class="empty-history">No notifications yet</div>
        </div>
      `;
      document.body.appendChild(this.historyPanel);
      
      // Add event listeners
      this.historyTab.addEventListener('click', () => this.toggleHistory());
      this.historyPanel.querySelector('.close-btn').addEventListener('click', () => this.toggleHistory(false));
      
      // Close history when clicking outside
      document.addEventListener('click', (e) => {
        if (this.isHistoryOpen && 
            !this.historyPanel.contains(e.target) && 
            !this.historyTab.contains(e.target)) {
          this.toggleHistory(false);
        }
      });
    }
    
    toggleHistory(force = null) {
      this.isHistoryOpen = force !== null ? force : !this.isHistoryOpen;
      
      if (this.isHistoryOpen) {
        this.historyPanel.classList.add('open');
        this.container.classList.add('history-open');
        // Reset badge
        this.updateBadge(0);
      } else {
        this.historyPanel.classList.remove('open');
        this.container.classList.remove('history-open');
      }
    }
    
    updateBadge(count) {
      const badge = this.historyTab.querySelector('.notification-badge');
      badge.textContent = count;
      
      if (count > 0) {
        badge.classList.add('show');
      } else {
        badge.classList.remove('show');
      }
    }
    
    addToHistory(data) {
      // Add to history data
      const historyItem = {
        id: `notification-${Date.now()}`,
        timestamp: new Date(),
        data: data
      };
      
      this.historyData.unshift(historyItem);
      this.renderHistory();
      
      // Update badge if history panel is not open
      if (!this.isHistoryOpen) {
        const currentCount = parseInt(this.historyTab.querySelector('.notification-badge').textContent);
        this.updateBadge(currentCount + 1);
      }
    }
    
    renderHistory() {
      const historyContent = this.historyPanel.querySelector('.history-content');
      
      if (this.historyData.length === 0) {
        historyContent.innerHTML = `<div class="empty-history">No notifications yet</div>`;
        return;
      }
      
      historyContent.innerHTML = this.historyData.map(item => {
        const person = item.data.people[0];
        const phones = person.phone_numbers || [];
        const firstName = person.first_name || '';
        const lastName = person.last_name || '';
        const company = person.company || '';
        const fullName = `${firstName} ${lastName}`.trim();
        const phoneText = phones.length ? phones.map(p => p.raw_number).join(', ') : 'None';
        const formattedTime = item.timestamp.toLocaleTimeString();
        const formattedDate = item.timestamp.toLocaleDateString();
        const isFailure = phones.length === 0 || person.status === "failure";
        
        let displayName = fullName;
        if (company) {
          displayName += displayName ? ` - ${company}` : company;
        }
        
        if (!displayName) {
          displayName = 'Unknown Contact';
        }
        
        return `
          <div class="history-item${isFailure ? ' history-item-failure' : ''}" data-id="${item.id}">
            <div class="history-item-header">
              <span>${isFailure ? this.icons.x : this.icons.phone} ${displayName}</span>
              <span class="history-timestamp">${formattedTime} ${formattedDate}</span>
            </div>
            <div class="history-phones">
              ${isFailure ? '<span style="color:#6c757d;font-style:italic;">No numbers found</span>' : phoneText}
            </div>
          </div>
        `;
      }).join('');
      
      // Add click handlers to history items
      const historyItems = historyContent.querySelectorAll('.history-item');
      historyItems.forEach(item => {
        item.addEventListener('click', () => {
          const id = item.getAttribute('data-id');
          const historyItem = this.historyData.find(h => h.id === id);
          if (historyItem) {
            this.showNotification(historyItem.data, false);
          }
        });
      });
    }
  
    createNotification(data, addToHistory = true, isFailure = false) {
      const person = data.people[0];
      const phones = person.phone_numbers || [];
      const firstName = person.first_name || '';
      const lastName = person.last_name || '';
      const company = person.company || '';
      const fullName = `${firstName} ${lastName}`.trim();
      
      // Create notification element
      const notification = document.createElement('div');
      notification.className = isFailure ? 'notification failure' : 'notification';
      
      // Create header
      const header = document.createElement('div');
      header.className = 'notification-header';
      
      if (isFailure) {
        header.innerHTML = `
          <div class="notification-title">
            <span class="notification-icon">${this.icons.x}</span>
            <span>No number found</span>
            <span class="expand-icon">${this.icons.chevronDown}</span>
          </div>
        `;
      } else {
        header.innerHTML = `
          <div class="notification-title">
            <span class="notification-icon">${this.icons.phone}</span>
            <span>New contact found</span>
            <span class="expand-icon">${this.icons.chevronDown}</span>
          </div>
        `;
      }
      
      // Close button
      const closeBtn = document.createElement('button');
      closeBtn.className = 'close-btn';
      closeBtn.innerHTML = this.icons.close;
      closeBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        this.removeNotification(notification);
      });
      header.appendChild(closeBtn);
      
      // Create content
      const content = document.createElement('div');
      content.className = 'notification-content';
      
      // Add person info to content
      if (fullName) {
        const nameElement = document.createElement('div');
        nameElement.className = 'notification-name';
        nameElement.innerHTML = `<strong>${fullName}</strong>`;
        content.appendChild(nameElement);
      }
      
      if (company) {
        const companyElement = document.createElement('div');
        companyElement.className = 'notification-company';
        companyElement.textContent = company;
        content.appendChild(companyElement);
      }
      
      if (isFailure) {
        // Add failure message
        const failureMsg = document.createElement('div');
        failureMsg.className = 'notification-failure-msg';
        failureMsg.style.marginTop = '8px';
        failureMsg.style.fontSize = '13px';
        failureMsg.style.opacity = '0.9';
        failureMsg.innerHTML = 'No phone numbers were found for this contact.';
        content.appendChild(failureMsg);
      } else {
        // Add separator
        if ((fullName || company) && phones.length > 0) {
          const separator = document.createElement('div');
          separator.className = 'notification-separator';
          separator.style.margin = '8px 0';
          separator.style.borderBottom = '1px solid rgba(255,255,255,0.2)';
          content.appendChild(separator);
        }
        
        // Add phone numbers to content
        if (phones.length > 0) {
          const phoneHeader = document.createElement('div');
          phoneHeader.className = 'notification-phone-header';
          phoneHeader.innerHTML = `<small>${phones.length > 1 ? 'PHONE NUMBERS' : 'PHONE NUMBER'}</small>`;
          phoneHeader.style.opacity = '0.7';
          phoneHeader.style.fontSize = '11px';
          phoneHeader.style.fontWeight = '500';
          phoneHeader.style.marginTop = '4px';
          content.appendChild(phoneHeader);
          
          phones.forEach(phone => {
            const phoneElement = document.createElement('div');
            phoneElement.className = 'notification-phone';
            phoneElement.textContent = phone.raw_number;
            content.appendChild(phoneElement);
          });
        }
      }
      
      // Toggle expand on header click
      header.addEventListener('click', () => {
        content.classList.toggle('expanded');
        header.classList.toggle('expanded');
      });
      
      // Assemble notification
      notification.appendChild(header);
      notification.appendChild(content);
      
      // Add to container and animate in
      this.container.appendChild(notification);
      
      // Trigger reflow for animation
      notification.offsetHeight;
      notification.classList.add('show');
      
      // Add to history if needed
      if (addToHistory) {
        this.addToHistory(data);
      }
      
      return notification;
    }
  
    removeNotification(notification) {
      notification.classList.remove('show');
      setTimeout(() => {
        if (notification.parentNode === this.container) {
          this.container.removeChild(notification);
        }
      }, 300);
    }
  
    showNotification(data, addToHistory = true, isFailure = false) {
      return this.createNotification(data, addToHistory, isFailure);
    }
  }
  
  // Initialize notification system
  const notificationSystem = new NotificationSystem();
  
  // Initialize with existing blob names to avoid showing existing data
  async function initializeSeenFiles() {
    try {
      const res = await fetch(`${storageContainerUrl}?restype=container&comp=list`);
      const text = await res.text();
      const parser = new DOMParser();
      const xml = parser.parseFromString(text, "application/xml");
      const blobs = xml.getElementsByTagName("Name");
  
      for (let i = 0; i < blobs.length; i++) {
        const blobName = blobs[i].textContent;
        seenFiles.add(blobName);
      }
      console.log(`Initialized with ${seenFiles.size} existing blobs`);
    } catch (err) {
      console.error("Initialization error:", err);
    }
  }
  
  // Poll the container for new files with user_id = 1
  async function pollWebhookContainer() {
    try {
      const res = await fetch(`${storageContainerUrl}?restype=container&comp=list`);
      const text = await res.text();
      const parser = new DOMParser();
      const xml = parser.parseFromString(text, "application/xml");
      const blobs = xml.getElementsByTagName("Name");
  
      for (let i = 0; i < blobs.length; i++) {
        const blobName = blobs[i].textContent;
        
        // Filename format: person_id_status_datetime_user_id.json
        const parts = blobName.split('_');
       const userIdWithExtension = parts[parts.length - 1]; // e.g., "1.json"
       const userId = userIdWithExtension.split('.')[0]; // extract "1" from "1.json"
       // Use the logged-in user's ID instead of hardcoding "1"
       if (userId !== filterValues.usrID.toString()) continue;  // Skip files that are not for the logged-in user

  
        if (seenFiles.has(blobName)) continue;
        seenFiles.add(blobName);
  
        // Fetch and inspect the blob
        const blobRes = await fetch(`${storageContainerUrl}/${blobName}`);
        const blobData = await blobRes.json();
  
        const person = blobData?.people?.[0];
        
        if (blobData.status === "success") {
          // Check if it's a success or failure based on phone numbers or explicit status
          if (person) {
            const phoneNumbers = person.phone_numbers || [];
            const isSuccess = phoneNumbers.length > 0;
            const isFailure = person.status === "failure" || phoneNumbers.length === 0;
            
            if (isSuccess) {
              notificationSystem.showNotification(blobData, true, false);
            } else if (isFailure) {
              notificationSystem.showNotification(blobData, true, true);
            }
          }
        }
      }
    } catch (err) {
      console.error("Polling error:", err);
    }
  }
  
  // Initialize seen files first, then start polling
  (async function() {
    await initializeSeenFiles();
    // Start regular polling after initialization
    setInterval(pollWebhookContainer, pollingInterval);
  })();
  </script>      
</body>
</html>
