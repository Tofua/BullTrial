<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Power BI Report Embed</title>
  <!-- Include the Power BI client library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/powerbi-client/2.19.1/powerbi.min.js"></script>
  <style>
    #embedContainer {
      width: 100%;
      height: 600px;
    }
  </style>
</head>
<body>
  <div id="embedContainer"></div>
  <script>
    document.addEventListener('DOMContentLoaded', async function() {
      const tokenUrl = "https://powerbi-auth-api-a7d4aydgc2d4hrhu.uksouth-01.azurewebsites.net/get-token";
      
      try {
        const response = await fetch(tokenUrl);
        const data = await response.json();
        console.log("Token API response:", data);
        
        if (!data.accessToken) {
          console.error("No access token found in response.");
          return;
        }
        
        const accessToken = data.accessToken;
        
        // Retrieve the models from the library.
        // This is where we get properties like TokenType and Permissions.
        let models = window['powerbi-client'].models;
        if (!models) {
          console.error("Power BI models not found.");
          return;
        }
        
        // Configure the embed settings.
        const embedConfiguration = {
          type: 'report',
          tokenType: models.TokenType.Aad,  // Using AAD token type for embed-for-your-organization.
          accessToken: accessToken,
          // Use the base embed URL.
          embedUrl: "https://app.powerbi.com/reportEmbed",
          id: "782913b3-f792-4f84-bc87-d46092f64932",
          permissions: models.Permissions.All,
          settings: {
            panes: {
              filters: { visible: true },
              pageNavigation: { visible: true }
            },
            bars: {
              statusBar: { visible: true }
            }
          }
        };

        // Get the container element.
        const embedContainer = document.getElementById('embedContainer');
        if (!embedContainer) {
          console.error("Embed container not found.");
          return;
        }
        
        // Embed the report using the global powerbi object.
        const report = powerbi.embed(embedContainer, embedConfiguration);

        report.on("loaded", function() {
          console.log("Report loaded.");
        });

        report.on("rendered", function() {
          console.log("Report rendered.");
        });

        report.on("error", function(event) {
          console.error("Report error:", event.detail);
        });
      } catch (error) {
        console.error("Error fetching token or embedding report:", error);
      }
    });
  </script>
</body>
</html>
